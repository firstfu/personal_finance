# v1.1 Improvements Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add Dark Mode support, fix save bug, add Account model with balance tracking, and expand Settings page with appearance/export/reset.

**Architecture:** New Account @Model with Transaction relationship. AppTheme switched to semantic colors for Dark Mode. Settings expanded with 4 new sections. All UI text in Traditional Chinese.

**Tech Stack:** Swift, SwiftUI, SwiftData, iOS 26.2

**Build command:** `xcodebuild -project personal_finance.xcodeproj -scheme personal_finance -destination 'platform=iOS Simulator,id=CDBF104B-5DB1-48C7-9E80-F483AC4A2C06' build 2>&1 | tail -30`

**Test command:** `xcodebuild test -project personal_finance.xcodeproj -scheme personal_finance -destination 'platform=iOS Simulator,id=CDBF104B-5DB1-48C7-9E80-F483AC4A2C06' -only-testing:personal_financeTests 2>&1 | tail -30`

---

### Task 1: Dark Mode — AppTheme Semantic Colors

**Files:**
- Modify: `personal_finance/Theme/AppTheme.swift`

**Step 1: Replace hardcoded colors with semantic colors**

Replace the full content of `personal_finance/Theme/AppTheme.swift` with:

```swift
import SwiftUI

enum AppTheme {
    // Brand colors (fixed, don't change with dark mode)
    static let primary = Color(hex: "#8BC34A")
    static let primaryDark = Color(hex: "#2E7D32")
    static let income = Color(hex: "#4CAF50")
    static let expense = Color(hex: "#E53935")

    // Semantic colors (adapt to dark mode automatically)
    static let surface = Color(.secondarySystemBackground)
    static let onBackground = Color(.label)
    static let secondaryText = Color(.secondaryLabel)

    static let primaryGradient = LinearGradient(
        colors: [primary, primaryDark],
        startPoint: .topLeading,
        endPoint: .bottomTrailing
    )

    static let cardCornerRadius: CGFloat = 16
    static let buttonCornerRadius: CGFloat = 12
    static let horizontalPadding: CGFloat = 16
    static let cardSpacing: CGFloat = 12

    static let amountFont = Font.system(.largeTitle, design: .rounded, weight: .bold)
    static let titleFont = Font.title2.bold()
    static let captionFont = Font.caption
}
```

**Step 2: Build to verify**

```bash
xcodebuild -project personal_finance.xcodeproj -scheme personal_finance \
  -destination 'platform=iOS Simulator,id=CDBF104B-5DB1-48C7-9E80-F483AC4A2C06' build 2>&1 | tail -10
```

Expected: BUILD SUCCEEDED

**Step 3: Commit**

```bash
git add personal_finance/Theme/AppTheme.swift
git commit -m "fix: use semantic colors for Dark Mode support in AppTheme"
```

---

### Task 2: Dark Mode — Appearance Setting + ContentView Integration

**Files:**
- Modify: `personal_finance/ContentView.swift`

**Step 1: Add appearance setting to ContentView**

Replace `personal_finance/ContentView.swift` with:

```swift
import SwiftUI
import SwiftData

struct ContentView: View {
    @AppStorage("hasCompletedOnboarding") private var hasCompletedOnboarding = false
    @AppStorage("appColorScheme") private var appColorScheme = "system"

    private var colorScheme: ColorScheme? {
        switch appColorScheme {
        case "light": return .light
        case "dark": return .dark
        default: return nil
        }
    }

    var body: some View {
        Group {
            if hasCompletedOnboarding {
                mainTabView
            } else {
                OnboardingView()
            }
        }
        .preferredColorScheme(colorScheme)
    }

    private var mainTabView: some View {
        TabView {
            HomeView()
                .tabItem {
                    Label("首頁", systemImage: "house.fill")
                }

            AddTransactionView()
                .tabItem {
                    Label("記帳", systemImage: "plus.circle.fill")
                }

            AnalyticsView()
                .tabItem {
                    Label("分析", systemImage: "chart.bar.fill")
                }

            SettingsView()
                .tabItem {
                    Label("設定", systemImage: "gearshape.fill")
                }
        }
        .tint(AppTheme.primaryDark)
    }
}

#Preview {
    ContentView()
        .modelContainer(for: [Transaction.self, Category.self], inMemory: true)
}
```

**Step 2: Build**

Expected: BUILD SUCCEEDED

**Step 3: Commit**

```bash
git add personal_finance/ContentView.swift
git commit -m "feat: add color scheme preference with system/light/dark support"
```

---

### Task 3: Fix Save Bug in AddTransactionView

**Files:**
- Modify: `personal_finance/Views/AddTransactionView.swift`

**Step 1: Fix saveTransaction and overlay**

In `personal_finance/Views/AddTransactionView.swift`, make these changes:

**Change 1:** In `saveTransaction()`, add explicit save after insert. Replace lines 136-160:

```swift
    private func saveTransaction() {
        guard let amount = Decimal(string: amountText), amount > 0 else { return }
        let transaction = Transaction(
            amount: amount,
            type: selectedType,
            category: selectedCategory,
            note: note,
            date: date
        )
        modelContext.insert(transaction)
        try? modelContext.save()

        amountText = ""
        selectedCategory = nil
        note = ""
        date = .now

        withAnimation {
            showSavedFeedback = true
        }
        DispatchQueue.main.asyncAfter(deadline: .now() + 1.5) {
            withAnimation {
                showSavedFeedback = false
            }
        }
    }
```

**Change 2:** Move the overlay outside NavigationStack to ensure visibility. Replace the entire `body` (lines 26-61):

```swift
    var body: some View {
        ZStack {
            NavigationStack {
                ScrollView {
                    VStack(spacing: 20) {
                        Picker("類型", selection: $selectedType) {
                            Text("支出").tag(TransactionType.expense)
                            Text("收入").tag(TransactionType.income)
                        }
                        .pickerStyle(.segmented)
                        .onChange(of: selectedType) {
                            selectedCategory = nil
                        }

                        amountSection
                        categoryGrid

                        DatePicker("日期", selection: $date, displayedComponents: .date)
                            .datePickerStyle(.compact)
                            .padding(.horizontal, 4)

                        TextField("備註（選填）", text: $note)
                            .textFieldStyle(.roundedBorder)

                        saveButton
                    }
                    .padding(.horizontal, AppTheme.horizontalPadding)
                    .padding(.top, 8)
                }
                .navigationTitle("記帳")
            }

            if showSavedFeedback {
                Color.black.opacity(0.2)
                    .ignoresSafeArea()
                    .transition(.opacity)
                savedOverlay
            }
        }
        .animation(.easeInOut, value: showSavedFeedback)
    }
```

**Step 2: Build**

Expected: BUILD SUCCEEDED

**Step 3: Commit**

```bash
git add personal_finance/Views/AddTransactionView.swift
git commit -m "fix: add explicit save and fix overlay visibility in AddTransactionView"
```

---

### Task 4: Account Model + AccountType Enum

**Files:**
- Create: `personal_finance/Models/AccountType.swift`
- Create: `personal_finance/Models/Account.swift`
- Modify: `personal_finance/Models/Transaction.swift`

**Step 1: Create AccountType enum**

Create `personal_finance/Models/AccountType.swift`:

```swift
import Foundation

enum AccountType: String, Codable, CaseIterable {
    case cash
    case bank
    case creditCard
    case eWallet

    var displayName: String {
        switch self {
        case .cash: "現金"
        case .bank: "銀行存款"
        case .creditCard: "信用卡"
        case .eWallet: "電子支付"
        }
    }

    var defaultIcon: String {
        switch self {
        case .cash: "banknote.fill"
        case .bank: "building.columns.fill"
        case .creditCard: "creditcard.fill"
        case .eWallet: "iphone.gen3"
        }
    }
}
```

**Step 2: Create Account model**

Create `personal_finance/Models/Account.swift`:

```swift
import Foundation
import SwiftData

@Model
final class Account {
    var name: String
    var type: AccountType
    var icon: String
    var colorHex: String
    var initialBalance: Decimal
    var sortOrder: Int
    var isDefault: Bool

    @Relationship(deleteRule: .nullify, inverse: \Transaction.account)
    var transactions: [Transaction]

    init(name: String, type: AccountType, icon: String, colorHex: String, initialBalance: Decimal = 0, sortOrder: Int = 0, isDefault: Bool = false) {
        self.name = name
        self.type = type
        self.icon = icon
        self.colorHex = colorHex
        self.initialBalance = initialBalance
        self.sortOrder = sortOrder
        self.isDefault = isDefault
        self.transactions = []
    }

    var currentBalance: Decimal {
        let incomeTotal = transactions
            .filter { $0.type == .income }
            .reduce(Decimal.zero) { $0 + $1.amount }
        let expenseTotal = transactions
            .filter { $0.type == .expense }
            .reduce(Decimal.zero) { $0 + $1.amount }
        return initialBalance + incomeTotal - expenseTotal
    }
}
```

**Step 3: Add account field to Transaction**

Replace `personal_finance/Models/Transaction.swift`:

```swift
import Foundation
import SwiftData

@Model
final class Transaction {
    var amount: Decimal
    var type: TransactionType
    var category: Category?
    var account: Account?
    var note: String
    var date: Date
    var createdAt: Date

    init(amount: Decimal, type: TransactionType, category: Category? = nil, account: Account? = nil, note: String = "", date: Date = .now) {
        self.amount = amount
        self.type = type
        self.category = category
        self.account = account
        self.note = note
        self.date = date
        self.createdAt = .now
    }
}
```

**Step 4: Build** — may fail until schema is updated in Task 5.

**Step 5: Commit**

```bash
git add personal_finance/Models/AccountType.swift personal_finance/Models/Account.swift personal_finance/Models/Transaction.swift
git commit -m "feat: add Account model with balance tracking and Transaction relationship"
```

---

### Task 5: Update Schema + Default Account Seeding

**Files:**
- Modify: `personal_finance/personal_financeApp.swift`
- Modify: `personal_finance/Models/DefaultCategories.swift`

**Step 1: Add default accounts to DefaultCategories**

Add at the end of `personal_finance/Models/DefaultCategories.swift`, inside the `DefaultCategories` enum before the closing `}`:

```swift
    struct AccountData {
        let name: String
        let type: AccountType
        let icon: String
        let colorHex: String
        let sortOrder: Int
    }

    static let defaultAccounts: [AccountData] = [
        .init(name: "現金", type: .cash, icon: "banknote.fill", colorHex: "#4CAF50", sortOrder: 0),
        .init(name: "銀行存款", type: .bank, icon: "building.columns.fill", colorHex: "#2196F3", sortOrder: 1),
        .init(name: "信用卡", type: .creditCard, icon: "creditcard.fill", colorHex: "#FF9800", sortOrder: 2),
    ]

    static func seedAccounts(into context: ModelContext) {
        let descriptor = FetchDescriptor<Account>()
        let count = (try? context.fetchCount(descriptor)) ?? 0
        guard count == 0 else { return }

        for data in defaultAccounts {
            let account = Account(
                name: data.name,
                type: data.type,
                icon: data.icon,
                colorHex: data.colorHex,
                sortOrder: data.sortOrder,
                isDefault: true
            )
            context.insert(account)
        }
    }
```

**Step 2: Update App schema and seeding**

Replace `personal_finance/personal_financeApp.swift`:

```swift
import SwiftUI
import SwiftData

@main
struct personal_financeApp: App {
    var sharedModelContainer: ModelContainer = {
        let schema = Schema([
            Transaction.self,
            Category.self,
            Account.self,
        ])
        let modelConfiguration = ModelConfiguration(schema: schema, isStoredInMemoryOnly: false)

        do {
            return try ModelContainer(for: schema, configurations: [modelConfiguration])
        } catch {
            fatalError("Could not create ModelContainer: \(error)")
        }
    }()

    var body: some Scene {
        WindowGroup {
            ContentView()
                .onAppear {
                    let context = sharedModelContainer.mainContext
                    DefaultCategories.seed(into: context)
                    DefaultCategories.seedAccounts(into: context)
                }
        }
        .modelContainer(sharedModelContainer)
    }
}
```

**Step 3: Update ContentView preview**

In `personal_finance/ContentView.swift`, update the #Preview:

```swift
#Preview {
    ContentView()
        .modelContainer(for: [Transaction.self, Category.self, Account.self], inMemory: true)
}
```

**Step 4: Update tests to include account**

In `personal_financeTests/personal_financeTests.swift`, add a new test:

```swift
struct AccountTests {
    @Test func accountInitialization() async throws {
        let account = Account(name: "現金", type: .cash, icon: "banknote.fill", colorHex: "#4CAF50", initialBalance: 10000)
        #expect(account.name == "現金")
        #expect(account.type == .cash)
        #expect(account.initialBalance == 10000)
    }

    @Test func accountTypeDisplayName() async throws {
        #expect(AccountType.cash.displayName == "現金")
        #expect(AccountType.bank.displayName == "銀行存款")
        #expect(AccountType.creditCard.displayName == "信用卡")
        #expect(AccountType.eWallet.displayName == "電子支付")
    }
}
```

**Step 5: Build and test**

```bash
xcodebuild test -project personal_finance.xcodeproj -scheme personal_finance \
  -destination 'platform=iOS Simulator,id=CDBF104B-5DB1-48C7-9E80-F483AC4A2C06' \
  -only-testing:personal_financeTests 2>&1 | tail -20
```

Expected: All tests pass.

**Step 6: Commit**

```bash
git add -A
git commit -m "feat: add Account to schema, default accounts seeding, and account tests"
```

---

### Task 6: AddTransactionView — Account Selector

**Files:**
- Modify: `personal_finance/Views/AddTransactionView.swift`

**Step 1: Add account query and state**

Add after line 13 (`@Query(sort: \Category.sortOrder) private var categories: [Category]`):

```swift
    @Query(sort: \Account.sortOrder) private var accounts: [Account]
    // ... existing @State vars ...
    @State private var selectedAccount: Account?
```

**Step 2: Add account selector UI**

Add an `accountSelector` computed property and insert it in the body VStack after the segmented picker, before `amountSection`:

```swift
    private var accountSelector: some View {
        VStack(alignment: .leading, spacing: 8) {
            Text("帳戶")
                .font(AppTheme.captionFont)
                .foregroundStyle(AppTheme.secondaryText)

            ScrollView(.horizontal, showsIndicators: false) {
                HStack(spacing: 8) {
                    ForEach(accounts) { account in
                        let isSelected = selectedAccount?.id == account.id
                        Button {
                            selectedAccount = account
                        } label: {
                            HStack(spacing: 6) {
                                Image(systemName: account.icon)
                                    .font(.caption)
                                Text(account.name)
                                    .font(.subheadline)
                            }
                            .padding(.horizontal, 12)
                            .padding(.vertical, 8)
                            .background(isSelected ? AppTheme.primaryDark : AppTheme.surface)
                            .foregroundStyle(isSelected ? .white : AppTheme.onBackground)
                            .clipShape(Capsule())
                        }
                        .buttonStyle(.plain)
                    }
                }
            }
        }
    }
```

**Step 3: Update canSave to require account**

```swift
    private var canSave: Bool {
        guard let amount = Decimal(string: amountText), amount > 0 else { return false }
        return selectedCategory != nil && selectedAccount != nil
    }
```

**Step 4: Update saveTransaction to include account**

In `saveTransaction()`, change the Transaction init to include account:

```swift
        let transaction = Transaction(
            amount: amount,
            type: selectedType,
            category: selectedCategory,
            account: selectedAccount,
            note: note,
            date: date
        )
```

And add `selectedAccount = nil` to the reset block (or keep it selected for convenience — keep it selected since users often use the same account).

**Step 5: Add `accountSelector` to body VStack**

In the body, insert `accountSelector` between the segmented picker and `amountSection`.

**Step 6: Auto-select default account on appear**

Add `.onAppear` to the outermost ZStack:

```swift
.onAppear {
    if selectedAccount == nil {
        selectedAccount = accounts.first(where: { $0.isDefault }) ?? accounts.first
    }
}
```

**Step 7: Build**

Expected: BUILD SUCCEEDED

**Step 8: Commit**

```bash
git add personal_finance/Views/AddTransactionView.swift
git commit -m "feat: add account selector to AddTransactionView"
```

---

### Task 7: HomeView — Account Balance Overview

**Files:**
- Modify: `personal_finance/Views/HomeView.swift`

**Step 1: Add account query**

Add after line 12-13:

```swift
    @Query(sort: \Account.sortOrder) private var accounts: [Account]
```

**Step 2: Add account balance section**

Add this computed property:

```swift
    private var accountBalanceSection: some View {
        VStack(alignment: .leading, spacing: 8) {
            Text("帳戶餘額")
                .font(.headline)

            ForEach(accounts) { account in
                HStack(spacing: 12) {
                    ZStack {
                        Circle()
                            .fill(Color(hex: account.colorHex).opacity(0.15))
                            .frame(width: 36, height: 36)
                        Image(systemName: account.icon)
                            .font(.body)
                            .foregroundStyle(Color(hex: account.colorHex))
                    }
                    Text(account.name)
                        .font(.body)
                    Spacer()
                    Text(CurrencyFormatter.format(account.currentBalance))
                        .font(.body.bold().monospacedDigit())
                        .foregroundStyle(account.currentBalance >= 0 ? AppTheme.onBackground : AppTheme.expense)
                }
                .padding(.vertical, 2)
            }
        }
    }
```

**Step 3: Insert in body VStack**

Insert `accountBalanceSection` between `MonthlySummaryCard` and `recentTransactionsSection`.

**Step 4: Build**

Expected: BUILD SUCCEEDED

**Step 5: Commit**

```bash
git add personal_finance/Views/HomeView.swift
git commit -m "feat: add account balance overview to HomeView"
```

---

### Task 8: TransactionRow — Show Account Name

**Files:**
- Modify: `personal_finance/Views/Components/TransactionRow.swift`

**Step 1: Add account name display**

In the amount/date VStack (right side), add the account name below the date:

After the date Text, add:

```swift
                if let accountName = transaction.account?.name {
                    Text(accountName)
                        .font(.caption2)
                        .foregroundStyle(AppTheme.secondaryText)
                }
```

**Step 2: Build and commit**

```bash
git add personal_finance/Views/Components/TransactionRow.swift
git commit -m "feat: show account name in TransactionRow"
```

---

### Task 9: Expanded SettingsView — Appearance, Accounts, Export, Reset

**Files:**
- Modify: `personal_finance/Views/SettingsView.swift`
- Create: `personal_finance/Views/AccountFormView.swift`
- Create: `personal_finance/Helpers/CSVExporter.swift`

**Step 1: Create CSVExporter**

Create `personal_finance/Helpers/CSVExporter.swift`:

```swift
import Foundation

enum CSVExporter {
    static func export(transactions: [Transaction]) -> String {
        var csv = "日期,類型,分類,帳戶,金額,備註\n"
        let dateFormatter = DateFormatter()
        dateFormatter.dateFormat = "yyyy/MM/dd"

        for tx in transactions.sorted(by: { $0.date > $1.date }) {
            let dateStr = dateFormatter.string(from: tx.date)
            let typeStr = tx.type.displayName
            let categoryStr = tx.category?.name ?? "未分類"
            let accountStr = tx.account?.name ?? "未指定"
            let amountStr = "\(tx.amount)"
            let noteStr = tx.note.replacingOccurrences(of: ",", with: "，")
            csv += "\(dateStr),\(typeStr),\(categoryStr),\(accountStr),\(amountStr),\(noteStr)\n"
        }
        return csv
    }

    static func exportToFile(transactions: [Transaction]) -> URL? {
        let csv = export(transactions: transactions)
        let fileName = "personal_finance_export_\(Date.now.formatted(.dateTime.year().month().day())).csv"
        let url = FileManager.default.temporaryDirectory.appendingPathComponent(fileName)
        do {
            try csv.write(to: url, atomically: true, encoding: .utf8)
            return url
        } catch {
            return nil
        }
    }
}
```

**Step 2: Create AccountFormView**

Create `personal_finance/Views/AccountFormView.swift`:

```swift
import SwiftUI
import SwiftData

struct AccountFormView: View {
    enum Mode: Identifiable {
        case add
        case edit(Account)

        var id: String {
            switch self {
            case .add: return "add"
            case .edit(let acc): return "\(acc.persistentModelID.hashValue)"
            }
        }
    }

    let mode: Mode
    @Environment(\.modelContext) private var modelContext
    @Environment(\.dismiss) private var dismiss

    @State private var name = ""
    @State private var type: AccountType = .bank
    @State private var icon = "building.columns.fill"
    @State private var colorHex = "#2196F3"
    @State private var initialBalance = ""

    private let colorOptions = [
        "#4CAF50", "#2196F3", "#FF9800", "#E91E63",
        "#9C27B0", "#00BCD4", "#795548", "#607D8B",
        "#F44336", "#FFC107", "#3F51B5", "#8BC34A"
    ]

    var body: some View {
        NavigationStack {
            Form {
                TextField("名稱", text: $name)

                Picker("類型", selection: $type) {
                    ForEach(AccountType.allCases, id: \.self) { t in
                        Text(t.displayName).tag(t)
                    }
                }
                .onChange(of: type) {
                    icon = type.defaultIcon
                }

                Section("初始餘額") {
                    TextField("0", text: $initialBalance)
                        .keyboardType(.numberPad)
                }

                Section("顏色") {
                    LazyVGrid(columns: Array(repeating: GridItem(.flexible()), count: 6), spacing: 12) {
                        ForEach(colorOptions, id: \.self) { hex in
                            Button {
                                colorHex = hex
                            } label: {
                                Circle()
                                    .fill(Color(hex: hex))
                                    .frame(width: 32, height: 32)
                                    .overlay {
                                        if colorHex == hex {
                                            Image(systemName: "checkmark")
                                                .font(.caption.bold())
                                                .foregroundStyle(.white)
                                        }
                                    }
                            }
                            .buttonStyle(.plain)
                        }
                    }
                }
            }
            .navigationTitle(isEditing ? "編輯帳戶" : "新增帳戶")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("取消") { dismiss() }
                }
                ToolbarItem(placement: .confirmationAction) {
                    Button("儲存") {
                        save()
                        dismiss()
                    }
                    .disabled(name.isEmpty)
                }
            }
            .onAppear {
                if case .edit(let account) = mode {
                    name = account.name
                    type = account.type
                    icon = account.icon
                    colorHex = account.colorHex
                    initialBalance = "\(account.initialBalance)"
                }
            }
        }
    }

    private var isEditing: Bool {
        if case .edit = mode { return true }
        return false
    }

    private func save() {
        let balance = Decimal(string: initialBalance) ?? 0
        switch mode {
        case .add:
            let account = Account(
                name: name,
                type: type,
                icon: type.defaultIcon,
                colorHex: colorHex,
                initialBalance: balance,
                sortOrder: 99
            )
            modelContext.insert(account)
        case .edit(let account):
            account.name = name
            account.type = type
            account.icon = type.defaultIcon
            account.colorHex = colorHex
            account.initialBalance = balance
        }
    }
}
```

**Step 3: Replace SettingsView**

Replace the full content of `personal_finance/Views/SettingsView.swift`:

```swift
import SwiftUI
import SwiftData

struct SettingsView: View {
    @Environment(\.modelContext) private var modelContext
    @Query(sort: \Category.sortOrder) private var categories: [Category]
    @Query(sort: \Account.sortOrder) private var accounts: [Account]
    @Query(sort: \Transaction.date) private var allTransactions: [Transaction]

    @AppStorage("appColorScheme") private var appColorScheme = "system"

    @State private var showAddCategory = false
    @State private var editingCategory: Category?
    @State private var showAddAccount = false
    @State private var editingAccount: Account?
    @State private var showResetConfirmation = false
    @State private var exportURL: URL?
    @State private var showShareSheet = false

    var body: some View {
        NavigationStack {
            List {
                // MARK: - 外觀
                Section("外觀") {
                    Picker("外觀模式", selection: $appColorScheme) {
                        Text("跟隨系統").tag("system")
                        Text("淺色").tag("light")
                        Text("深色").tag("dark")
                    }
                }

                // MARK: - 帳戶管理
                Section("帳戶管理") {
                    ForEach(accounts) { account in
                        Button {
                            editingAccount = account
                        } label: {
                            HStack(spacing: 12) {
                                ZStack {
                                    Circle()
                                        .fill(Color(hex: account.colorHex).opacity(0.15))
                                        .frame(width: 36, height: 36)
                                    Image(systemName: account.icon)
                                        .foregroundStyle(Color(hex: account.colorHex))
                                }
                                VStack(alignment: .leading) {
                                    Text(account.name)
                                        .foregroundStyle(AppTheme.onBackground)
                                    Text(account.type.displayName)
                                        .font(.caption)
                                        .foregroundStyle(AppTheme.secondaryText)
                                }
                                Spacer()
                                Text(CurrencyFormatter.format(account.currentBalance))
                                    .font(.body.monospacedDigit())
                                    .foregroundStyle(AppTheme.onBackground)
                            }
                        }
                    }
                    .onDelete(perform: deleteAccounts)

                    Button {
                        showAddAccount = true
                    } label: {
                        Label("新增帳戶", systemImage: "plus.circle")
                    }
                }

                // MARK: - 支出分類
                Section("支出分類") {
                    ForEach(categories.filter { $0.type == .expense }) { category in
                        categoryRow(category)
                    }
                    .onDelete { offsets in
                        deleteCategories(offsets: offsets, type: .expense)
                    }
                }

                // MARK: - 收入分類
                Section("收入分類") {
                    ForEach(categories.filter { $0.type == .income }) { category in
                        categoryRow(category)
                    }
                    .onDelete { offsets in
                        deleteCategories(offsets: offsets, type: .income)
                    }
                }

                // MARK: - 資料
                Section("資料") {
                    if let url = exportURL {
                        ShareLink(item: url) {
                            Label("分享匯出的 CSV", systemImage: "square.and.arrow.up")
                        }
                    }
                    Button {
                        exportURL = CSVExporter.exportToFile(transactions: allTransactions)
                    } label: {
                        Label("匯出交易紀錄 (CSV)", systemImage: "doc.text")
                    }

                    Button(role: .destructive) {
                        showResetConfirmation = true
                    } label: {
                        Label("重設所有資料", systemImage: "trash")
                    }
                }

                // MARK: - 關於
                Section("關於") {
                    HStack {
                        Text("版本")
                        Spacer()
                        Text("1.1.0")
                            .foregroundStyle(AppTheme.secondaryText)
                    }
                }
            }
            .navigationTitle("設定")
            .toolbar {
                Button {
                    showAddCategory = true
                } label: {
                    Image(systemName: "plus")
                }
            }
            .sheet(isPresented: $showAddCategory) {
                CategoryFormView(mode: .add)
            }
            .sheet(item: $editingCategory) { category in
                CategoryFormView(mode: .edit(category))
            }
            .sheet(isPresented: $showAddAccount) {
                AccountFormView(mode: .add)
            }
            .sheet(item: $editingAccount) { account in
                AccountFormView(mode: .edit(account))
            }
            .alert("確認重設", isPresented: $showResetConfirmation) {
                Button("取消", role: .cancel) {}
                Button("重設", role: .destructive) {
                    resetAllData()
                }
            } message: {
                Text("這將刪除所有交易紀錄和帳戶資料。此操作無法復原。")
            }
        }
    }

    private func categoryRow(_ category: Category) -> some View {
        Button {
            editingCategory = category
        } label: {
            HStack(spacing: 12) {
                ZStack {
                    Circle()
                        .fill(Color(hex: category.colorHex).opacity(0.15))
                        .frame(width: 36, height: 36)
                    Image(systemName: category.icon)
                        .foregroundStyle(Color(hex: category.colorHex))
                }
                Text(category.name)
                    .foregroundStyle(AppTheme.onBackground)
                Spacer()
                if category.isDefault {
                    Text("預設")
                        .font(.caption)
                        .foregroundStyle(AppTheme.secondaryText)
                }
            }
        }
    }

    private func deleteCategories(offsets: IndexSet, type: TransactionType) {
        let filtered = categories.filter { $0.type == type }
        for index in offsets {
            let category = filtered[index]
            if !category.isDefault {
                modelContext.delete(category)
            }
        }
    }

    private func deleteAccounts(offsets: IndexSet) {
        for index in offsets {
            let account = accounts[index]
            if !account.isDefault {
                modelContext.delete(account)
            }
        }
    }

    private func resetAllData() {
        for tx in allTransactions {
            modelContext.delete(tx)
        }
        for account in accounts {
            modelContext.delete(account)
        }
        for category in categories {
            modelContext.delete(category)
        }
        try? modelContext.save()
        // Re-seed defaults
        DefaultCategories.seed(into: modelContext)
        DefaultCategories.seedAccounts(into: modelContext)
    }
}

// MARK: - CategoryFormView (unchanged, keep existing)

struct CategoryFormView: View {
    enum Mode: Identifiable {
        case add
        case edit(Category)

        var id: String {
            switch self {
            case .add: return "add"
            case .edit(let cat): return "\(cat.persistentModelID.hashValue)"
            }
        }
    }

    let mode: Mode
    @Environment(\.modelContext) private var modelContext
    @Environment(\.dismiss) private var dismiss

    @State private var name = ""
    @State private var icon = "tag.fill"
    @State private var colorHex = "#607D8B"
    @State private var type: TransactionType = .expense

    private let iconOptions = [
        "fork.knife", "car.fill", "gamecontroller.fill", "bag.fill",
        "house.fill", "cross.case.fill", "book.fill", "tag.fill",
        "briefcase.fill", "star.fill", "gift.fill", "heart.fill"
    ]

    private let colorOptions = [
        "#FF9800", "#2196F3", "#9C27B0", "#E91E63",
        "#795548", "#F44336", "#3F51B5", "#607D8B",
        "#4CAF50", "#FFC107", "#00BCD4", "#8BC34A"
    ]

    var body: some View {
        NavigationStack {
            Form {
                TextField("名稱", text: $name)

                Picker("類型", selection: $type) {
                    Text("支出").tag(TransactionType.expense)
                    Text("收入").tag(TransactionType.income)
                }

                Section("圖標") {
                    LazyVGrid(columns: Array(repeating: GridItem(.flexible()), count: 6), spacing: 12) {
                        ForEach(iconOptions, id: \.self) { ic in
                            Button {
                                icon = ic
                            } label: {
                                Image(systemName: ic)
                                    .font(.title3)
                                    .frame(width: 40, height: 40)
                                    .background(icon == ic ? Color(hex: colorHex).opacity(0.2) : Color.clear)
                                    .clipShape(Circle())
                            }
                            .buttonStyle(.plain)
                        }
                    }
                }

                Section("顏色") {
                    LazyVGrid(columns: Array(repeating: GridItem(.flexible()), count: 6), spacing: 12) {
                        ForEach(colorOptions, id: \.self) { hex in
                            Button {
                                colorHex = hex
                            } label: {
                                Circle()
                                    .fill(Color(hex: hex))
                                    .frame(width: 32, height: 32)
                                    .overlay {
                                        if colorHex == hex {
                                            Image(systemName: "checkmark")
                                                .font(.caption.bold())
                                                .foregroundStyle(.white)
                                        }
                                    }
                            }
                            .buttonStyle(.plain)
                        }
                    }
                }
            }
            .navigationTitle(isEditing ? "編輯分類" : "新增分類")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("取消") { dismiss() }
                }
                ToolbarItem(placement: .confirmationAction) {
                    Button("儲存") {
                        save()
                        dismiss()
                    }
                    .disabled(name.isEmpty)
                }
            }
            .onAppear {
                if case .edit(let category) = mode {
                    name = category.name
                    icon = category.icon
                    colorHex = category.colorHex
                    type = category.type
                }
            }
        }
    }

    private var isEditing: Bool {
        if case .edit = mode { return true }
        return false
    }

    private func save() {
        switch mode {
        case .add:
            let category = Category(
                name: name,
                icon: icon,
                colorHex: colorHex,
                type: type,
                sortOrder: 99
            )
            modelContext.insert(category)
        case .edit(let category):
            category.name = name
            category.icon = icon
            category.colorHex = colorHex
            category.type = type
        }
    }
}
```

**Step 4: Build and test**

```bash
xcodebuild test -project personal_finance.xcodeproj -scheme personal_finance \
  -destination 'platform=iOS Simulator,id=CDBF104B-5DB1-48C7-9E80-F483AC4A2C06' \
  -only-testing:personal_financeTests 2>&1 | tail -20
```

Expected: All tests pass.

**Step 5: Commit**

```bash
git add -A
git commit -m "feat: expand SettingsView with appearance, accounts, CSV export, and data reset"
```

---

### Task 10: Final Build Verification

**Step 1: Full build**

```bash
xcodebuild -project personal_finance.xcodeproj -scheme personal_finance \
  -destination 'platform=iOS Simulator,id=CDBF104B-5DB1-48C7-9E80-F483AC4A2C06' build 2>&1 | tail -10
```

Expected: BUILD SUCCEEDED

**Step 2: Full tests**

```bash
xcodebuild test -project personal_finance.xcodeproj -scheme personal_finance \
  -destination 'platform=iOS Simulator,id=CDBF104B-5DB1-48C7-9E80-F483AC4A2C06' \
  -only-testing:personal_financeTests 2>&1 | tail -20
```

Expected: All tests pass (6 tests: 2 Category + 2 Transaction + 2 Account).

**Step 3: Verify file structure**

```
personal_finance/
├── Models/
│   ├── TransactionType.swift
│   ├── AccountType.swift          ← NEW
│   ├── Category.swift
│   ├── Transaction.swift          ← MODIFIED (added account field)
│   ├── Account.swift              ← NEW
│   └── DefaultCategories.swift    ← MODIFIED (added account seeding)
├── Theme/
│   ├── AppTheme.swift             ← MODIFIED (semantic colors)
│   └── Color+Hex.swift
├── Helpers/
│   ├── CurrencyFormatter.swift
│   └── CSVExporter.swift          ← NEW
├── Views/
│   ├── HomeView.swift             ← MODIFIED (account balances)
│   ├── AddTransactionView.swift   ← MODIFIED (account selector, save fix)
│   ├── AnalyticsView.swift
│   ├── SettingsView.swift         ← MODIFIED (expanded)
│   ├── OnboardingView.swift
│   ├── AccountFormView.swift      ← NEW
│   └── Components/
│       ├── MonthlySummaryCard.swift
│       └── TransactionRow.swift   ← MODIFIED (show account)
├── ContentView.swift              ← MODIFIED (color scheme)
└── personal_financeApp.swift      ← MODIFIED (schema + seeding)
```

**Step 4: Final commit**

```bash
git add -A
git commit -m "chore: v1.1 complete — dark mode, accounts, expanded settings, save fix"
```

---

## Summary

| Task | Description | Files |
|------|-------------|-------|
| 1 | AppTheme semantic colors | AppTheme.swift |
| 2 | Color scheme preference | ContentView.swift |
| 3 | Fix save bug | AddTransactionView.swift |
| 4 | Account + AccountType models | Account.swift, AccountType.swift, Transaction.swift |
| 5 | Schema update + seeding | personal_financeApp.swift, DefaultCategories.swift |
| 6 | Account selector in add view | AddTransactionView.swift |
| 7 | Account balance in home | HomeView.swift |
| 8 | Account name in transaction row | TransactionRow.swift |
| 9 | Expanded settings | SettingsView.swift, AccountFormView.swift, CSVExporter.swift |
| 10 | Final verification | Build + test |
