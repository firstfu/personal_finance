# Personal Finance App v1.1 Improvements — Design Document

**Date:** 2026-02-17
**Status:** Approved

## Overview

4 項改進：暗黑模式支援、記帳儲存 Bug 修復、帳戶管理功能、設定頁擴充。

---

## 1. Dark Mode Support

### AppTheme 修改

將以下靜態 hex 顏色替換為系統語意色：

| 屬性 | 替換前 | 替換後 |
|------|--------|--------|
| `surface` | `Color(hex: "#F5F5F5")` | `Color(.secondarySystemBackground)` |
| `onBackground` | `Color(hex: "#1A1A1A")` | `Color(.label)` |
| `secondaryText` | `Color(hex: "#757575")` | `Color(.secondaryLabel)` |

保持不變的品牌色：`primary`、`primaryDark`、`income`、`expense`、`primaryGradient`。

### 三態外觀切換

```swift
@AppStorage("appColorScheme") var appColorScheme: String = "system"
// "system" | "light" | "dark"
```

在 ContentView 最外層套用 `.preferredColorScheme()` 根據設定值切換。

設定頁新增 Picker：淺色 / 深色 / 跟隨系統。

---

## 2. Save Bug Fix

### 問題

點擊儲存按鈕後無反應。

### 修復

1. `saveTransaction()` 內加入 `try? modelContext.save()` 顯式儲存
2. 將 `savedOverlay` 改為全螢幕 ZStack overlay 確保可見
3. 加入輸入驗證提示（金額為空時顯示紅色提示文字）

---

## 3. Account Model

### 新增 Account @Model

```swift
@Model
final class Account {
    var name: String
    var type: AccountType
    var icon: String
    var colorHex: String
    var initialBalance: Decimal
    var sortOrder: Int
    var isDefault: Bool

    @Relationship(deleteRule: .nullify, inverse: \Transaction.account)
    var transactions: [Transaction]

    var currentBalance: Decimal {
        let incomeTotal = transactions.filter { $0.type == .income }.reduce(0) { $0 + $1.amount }
        let expenseTotal = transactions.filter { $0.type == .expense }.reduce(0) { $0 + $1.amount }
        return initialBalance + incomeTotal - expenseTotal
    }
}

enum AccountType: String, Codable, CaseIterable {
    case cash        // 現金
    case bank        // 銀行存款
    case creditCard  // 信用卡
    case eWallet     // 電子支付
}
```

### Transaction 新增欄位

```swift
var account: Account?
```

### 預設帳戶

| 名稱 | 類型 | 圖標 | 初始餘額 |
|------|------|------|---------|
| 現金 | cash | banknote.fill | 0 |
| 銀行存款 | bank | building.columns.fill | 0 |
| 信用卡 | creditCard | creditcard.fill | 0 |

### UI 影響

- **AddTransactionView**：分類上方新增帳戶選擇列（水平膠囊按鈕）
- **HomeView**：摘要卡片下方加帳戶餘額概覽列
- **SettingsView**：新增帳戶管理 Section

---

## 4. Settings Page Expansion

### 新增 Section

```
List (Grouped)
├── Section: 外觀
│   └── Picker "外觀模式"：淺色 / 深色 / 跟隨系統
├── Section: 帳戶管理
│   ├── 帳戶列表（圖標 + 名稱 + 餘額）
│   └── + 新增帳戶
├── Section: 支出分類（現有）
├── Section: 收入分類（現有）
├── Section: 資料
│   ├── 匯出 CSV（ShareLink）
│   └── 重設所有資料（確認對話框）
└── Section: 關於
    └── 版本 1.0.0
```

### AccountFormView

```
Form
├── TextField "名稱"
├── Picker "類型"
├── TextField "初始餘額"
├── 圖標選擇 Grid
└── 顏色選擇 Grid
```

### CSV 匯出格式

```csv
日期,類型,分類,帳戶,金額,備註
```
