# 豆芽 2.5D SpriteKit 動畫設計

## Context

豆芽養成功能目前使用 SF Symbols + SwiftUI 簡單縮放動畫，視覺效果單調。本次升級為 SpriteKit 驅動的 2.5D Parallax 風格動畫，使用程式繪製（貝茲曲線）呈現豆芽的莖、葉、花，搭配粒子系統做澆水和升階特效。

## 設計決策

| 項目 | 決策 | 理由 |
|------|------|------|
| 技術框架 | SpriteKit | 原生框架、粒子系統強大、GPU 渲染性能佳 |
| 視覺風格 | Parallax 前景層次 | 適合單株植物聚焦，療癒氛圍 |
| 繪製方式 | 程式繪製（SKShapeNode + 貝茲曲線） | 零外部素材、精確控制生長動畫 |
| 澆水效果 | 粒子 + 生長動畫（~2.5 秒） | 視覺回饋明確但不過度打斷 |

## 場景架構

SpriteKit Scene 分為 4 個 z-layer：

| z-index | 層 | 內容 | 技術 |
|---------|-----|------|------|
| 0 | BackgroundLayer | 漸層天空，隨階段變色（暖橘→天藍→金色） | SKShapeNode 漸層填色 |
| 1 | GroundLayer | 弧形泥土地面 + 花盆 | SKShapeNode 貝茲曲線 |
| 2 | PlantLayer | 豆芽主體：莖、葉、花 | SKShapeNode + 貝茲曲線動畫 |
| 3 | EffectLayer | 粒子特效：水滴、光點、花瓣 | SKEmitterNode |

場景固定 400x400 點，`scaleMode = .aspectFit`。

## 植物各階段視覺

| 階段 | 元素 | 視覺描述 |
|------|------|---------|
| Stage 0 種子 | 種子球 + 泥土裂縫 | 橢圓形棕色種子半埋在土裡，微微搖動呼吸動畫 |
| Stage 1 發芽 | 種子 + 短莖 + 嫩芽 | 一根彎曲的嫩綠莖從種子冒出，頂端帶兩片小子葉 |
| Stage 2 小苗 | 莖（更高）+ 2-3 片葉 | 莖變高變粗，展開 2-3 片橢圓葉片，葉片微微搖擺 |
| Stage 3 茂盛 | 粗莖 + 多片葉 + 分枝 | 莖更粗壯，葉片更大更多，有小分枝，整體更豐滿 |
| Stage 4 開花 | 茂盛 + 花朵/果實 | 頂部開出花朵，花瓣展開，帶有光暈效果 |

## 動畫規格

### 常駐動畫（Idle）
- 葉片隨風擺動：`SKAction.rotate` 來回 ±5 度，duration 2-3 秒，永久循環
- 背景微弱光點：少量粒子緩慢飄動

### 澆水動畫（~2.5 秒）
1. **0-0.5s**：水滴粒子從上方落下（藍色圓形，受重力影響）
2. **0.5-2.0s**：莖可見地長高一小段（控制點 Y 值動畫），新葉展開
3. **1.5-2.5s**：光點粒子從植物向外散發（綠色/金色）

### 階段升級動畫（~3 秒）
1. 螢幕閃白 0.2 秒
2. 植物從舊階段 morph 到新階段（曲線控制點漸變）
3. 金色粒子爆發
4. 背景顏色隨階段漸變

## 檔案結構

```
personal_finance/
├── SpriteKit/
│   ├── SproutScene.swift          # 主 SKScene
│   ├── PlantNode.swift            # 豆芽植物節點
│   ├── GroundNode.swift           # 地面 + 花盆
│   ├── BackgroundNode.swift       # 漸層天空背景
│   └── ParticleEffects.swift      # 粒子效果工具
```

## 核心類別

### SproutScene: SKScene
- `configure(stage: Int, growthPoints: Int)` — 初始化/更新
- `playWaterAnimation(pointsEarned: Int, completion: () -> Void)` — 澆水
- `playStageUpAnimation(newStage: Int, completion: () -> Void)` — 升階
- 持有 PlantNode、GroundNode、BackgroundNode 引用

### PlantNode: SKNode
- 包含莖、葉片陣列、花朵
- `morphTo(stage: Int, animated: Bool)` — 階段轉換
- `growBy(amount: CGFloat)` — 微量生長
- `startIdleAnimation()` — 常駐搖擺
- 貝茲曲線控制點做插值動畫

### ParticleEffects
- `waterDrops() -> SKEmitterNode` — 水滴粒子
- `sparkles(color:) -> SKEmitterNode` — 光點粒子
- `stageUpBurst() -> SKEmitterNode` — 升階爆發

## SwiftUI 整合

```swift
// SproutTabView 中
SpriteView(scene: sproutScene, options: [.allowsTransparency])
    .frame(width: 400, height: 400)
```

- `SpriteView` 設定 `allowsTransparency` 融入 SwiftUI 背景
- Scene 作為 `@State` 持有
- 透過 public method 從 SwiftUI 驅動動畫

## 修改範圍

| 檔案 | 動作 | 說明 |
|------|------|------|
| `SpriteKit/SproutScene.swift` | 新建 | 主場景 |
| `SpriteKit/PlantNode.swift` | 新建 | 植物繪製核心 |
| `SpriteKit/GroundNode.swift` | 新建 | 地面花盆 |
| `SpriteKit/BackgroundNode.swift` | 新建 | 天空背景 |
| `SpriteKit/ParticleEffects.swift` | 新建 | 粒子工具 |
| `Views/SproutTabView.swift` | 修改 | plantVisual 替換為 SpriteView |
| `Views/AddTransactionView.swift` | 修改 | growthOverlay 使用小型 SpriteView |

不變的檔案：`SproutPlant`、`HarvestRecord`、`SproutGrowthService`、`SchemaVersioning`、`ContentView`
